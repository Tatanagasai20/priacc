pipeline {
    agent any

    environment {
        REMOTE_HOST = "ubuntu@65.0.169.165"  // Docker instance public IP
        CREDENTIALS_ID = 'test'              // Jenkins SSH credential ID
        FRONTEND_DIR = 'frontend'
        BACKEND_DIR = 'backend'
    }

    stages {
        stage('Clone') {
            steps {
                git 'https://github.com/Tatanagasai20/priacc.git'
            }
        }

        stage('Build & Deploy Frontend') {
            steps {
                sshagent([CREDENTIALS_ID]) {
                    sh """
                    ssh-keyscan -H 65.0.169.165 >> ~/.ssh/known_hosts
                    scp -r $FRONTEND_DIR $REMOTE_HOST:/home/ubuntu/
                    ssh $REMOTE_HOST '
                        cd /home/ubuntu/$FRONTEND_DIR &&
                        docker build -t frontend-app . &&
                        docker rm -f frontend-app || true &&
                        docker run -d --name frontend-app -p 3000:3000 frontend-app
                    '
                    """
                }
            }
        }

        stage('Build & Deploy Backend') {
            steps {
                sshagent([CREDENTIALS_ID]) {
                    sh """
                    ssh-keyscan -H 65.0.169.165 >> ~/.ssh/known_hosts
                    scp -r $BACKEND_DIR $REMOTE_HOST:/home/ubuntu/
                    ssh $REMOTE_HOST '
                        cd /home/ubuntu/$BACKEND_DIR &&
                        docker build -t backend-app . &&
                        docker rm -f backend-app || true &&
                        docker run -d --name backend-app -p 8080:8080 backend-app
                    '
                    """
                }
            }
        }
    }
}
